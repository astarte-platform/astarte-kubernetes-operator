---
- name: Deploy RabbitMQ
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - rabbitmq
  roles:
    - name: rabbitmq
      when: deploy_rabbitmq_k8s

- name: Deploy CFSSL
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - cfssl
  roles:
    - name: cfssl
      when: deploy_cfssl_k8s

- name: Deploy Cassandra
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - cassandra
  roles:
    - name: cassandra
      when: deploy_cassandra_k8s

- name: Deploy Astarte
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - astarte
  roles:
    # This deploys all needed dependencies such as secrets, configurations...
    - astarte-common

    # Deploy Housekeeping
    - role: astarte-generic-backend-service
      tags:
        - housekeeping
      astarte_app_name: housekeeping
      k8s_deployment_replicas: "{{ astarte_housekeeping_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_housekeeping_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_housekeeping_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_housekeeping_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_housekeeping_k8s_resources_limits_memory }}"
    - role: astarte-generic-api-service
      tags:
        - housekeeping
      astarte_app_name: housekeeping
      k8s_deployment_replicas: "{{ astarte_housekeeping_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_housekeeping_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_housekeeping_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_housekeeping_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_housekeeping_api_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: HOUSEKEEPING_API_JWT_PUBLIC_KEY_PATH
          value: "/jwtpubkey/public-key"
      k8s_deployment_additional_secret_volumes:
        - name: jwtpubkey
          secretName: housekeeping-jwt
      k8s_deployment_additional_volume_mounts:
        - name: jwtpubkey
          mountPath: "/jwtpubkey"
          readOnly: true

    # Deploy Realm Management
    - role: astarte-generic-backend-service
      tags:
        - realm_management
      astarte_app_name: realm_management
      k8s_deployment_replicas: "{{ astarte_realm_management_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_realm_management_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_realm_management_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_realm_management_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_realm_management_k8s_resources_limits_memory }}"
    - role: astarte-generic-api-service
      tags:
        - realm_management
      astarte_app_name: realm_management
      k8s_deployment_replicas: "{{ astarte_realm_management_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_realm_management_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_realm_management_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_realm_management_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_realm_management_api_k8s_resources_limits_memory }}"
      check_api_health: false

    # Deploy Pairing
    - role: astarte-generic-backend-service
      tags:
        - pairing
      astarte_app_name: pairing
      k8s_deployment_replicas: "{{ astarte_pairing_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_pairing_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_pairing_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_pairing_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_pairing_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: PAIRING_CFSSL_URL
          value: "{{ cfssl_url }}"
        - name: PAIRING_BROKER_URL
          value: "ssl://{{ mqtt_broker_dns }}:{{ mqtt_broker_port}}/"
    - role: astarte-generic-api-service
      tags:
        - pairing
      astarte_app_name: pairing
      k8s_deployment_replicas: "{{ astarte_pairing_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_pairing_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_pairing_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_pairing_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_pairing_api_k8s_resources_limits_memory }}"
      check_api_health: false
