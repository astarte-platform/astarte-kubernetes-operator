---
- name: Deploy RabbitMQ
  hosts: localhost
  remote_user: root
  connection: local
  roles:
    - name: rabbitmq
      when: deploy_rabbitmq_k8s

- name: Deploy Cassandra
  hosts: localhost
  remote_user: root
  connection: local
  roles:
    - name: cassandra
      when: deploy_cassandra_k8s

- name: Deploy Astarte
  hosts: localhost
  remote_user: root
  connection: local
  roles:
    # This deploys all needed dependencies such as secrets, configurations...
    - astarte-common

    # Deploy Housekeeping
    - role: astarte-generic-api-service
      tags:
        - housekeeping
      astarte_app_name: housekeeping
      k8s_deployment_replicas: "{{ astarte_housekeeping_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_housekeeping_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_housekeeping_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_housekeeping_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_housekeeping_api_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: HOUSEKEEPING_API_JWT_PUBLIC_KEY_PATH
          value: "/jwtpubkey/public-key"
      k8s_deployment_additional_secret_volumes:
        - name: jwtpubkey
          secretName: housekeeping-jwt
      k8s_deployment_additional_volume_mounts:
        - name: jwtpubkey
          mountPath: "/jwtpubkey"
          readOnly: true

