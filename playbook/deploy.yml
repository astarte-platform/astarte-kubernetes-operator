---
- name: Deploy RabbitMQ
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - rabbitmq
  roles:
    - name: rabbitmq
      when: deploy_rabbitmq_k8s

- name: Deploy VerneMQ
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - vernemq
  roles:
    - name: vernemq
      when: deploy_vernemq_k8s

- name: Deploy CFSSL
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - cfssl
  roles:
    - name: cfssl
      when: deploy_cfssl_k8s

- name: Retrieve CFSSL CA Secret
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - cfssl
  roles:
    - cfssl-ca-secret-job

- name: Deploy Cassandra
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - cassandra
  roles:
    - name: cassandra
      when: deploy_cassandra_k8s

- name: Deploy Astarte
  hosts: localhost
  remote_user: root
  connection: local
  tags:
    - astarte
  roles:
    # This deploys all needed dependencies such as secrets, configurations...
    - astarte-common

    # Deploy Housekeeping
    - role: astarte-generic-backend-service
      tags:
        - housekeeping
      astarte_app_name: housekeeping
      k8s_deployment_replicas: "{{ astarte_housekeeping_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_housekeeping_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_housekeeping_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_housekeeping_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_housekeeping_k8s_resources_limits_memory }}"
    - role: astarte-generic-api-service
      tags:
        - housekeeping
      astarte_app_name: housekeeping
      k8s_deployment_replicas: "{{ astarte_housekeeping_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_housekeeping_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_housekeeping_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_housekeeping_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_housekeeping_api_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: HOUSEKEEPING_API_JWT_PUBLIC_KEY_PATH
          value: "/jwtpubkey/public-key"
      k8s_deployment_additional_secret_volumes:
        - name: jwtpubkey
          secretName: housekeeping-jwt
      k8s_deployment_additional_volume_mounts:
        - name: jwtpubkey
          mountPath: "/jwtpubkey"
          readOnly: true

    # Deploy Realm Management
    - role: astarte-generic-backend-service
      tags:
        - realm_management
      astarte_app_name: realm_management
      k8s_deployment_replicas: "{{ astarte_realm_management_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_realm_management_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_realm_management_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_realm_management_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_realm_management_k8s_resources_limits_memory }}"
    - role: astarte-generic-api-service
      tags:
        - realm_management
      astarte_app_name: realm_management
      k8s_deployment_replicas: "{{ astarte_realm_management_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_realm_management_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_realm_management_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_realm_management_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_realm_management_api_k8s_resources_limits_memory }}"
      check_api_health: false

    # Deploy Pairing
    - role: astarte-generic-backend-service
      tags:
        - pairing
      astarte_app_name: pairing
      k8s_deployment_replicas: "{{ astarte_pairing_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_pairing_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_pairing_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_pairing_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_pairing_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: PAIRING_CFSSL_URL
          value: "{{ cfssl_url }}"
        - name: PAIRING_BROKER_URL
          value: "ssl://{{ mqtt_broker_dns }}:{{ mqtt_broker_port}}/"
    - role: astarte-generic-api-service
      tags:
        - pairing
      astarte_app_name: pairing
      k8s_deployment_replicas: "{{ astarte_pairing_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_pairing_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_pairing_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_pairing_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_pairing_api_k8s_resources_limits_memory }}"
      check_api_health: false

    # Deploy Data Updater Plant
    - role: astarte-generic-backend-service
      tags:
        - data_updater_plant
      astarte_app_name: data_updater_plant
      k8s_deployment_replicas: "{{ astarte_data_updater_plant_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_data_updater_plant_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_data_updater_plant_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_data_updater_plant_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_data_updater_plant_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: DATA_UPDATER_PLANT_AMQP_CONSUMER_HOST
          value: "{{ rabbitmq_connection_host }}"
        - name: DATA_UPDATER_PLANT_AMQP_PRODUCER_HOST
          value: "{{ rabbitmq_connection_host }}"
        - name: DATA_UPDATER_PLANT_AMQP_PRODUCER_VIRTUAL_HOST
          value: "/"
        - name: DATA_UPDATER_PLANT_AMQP_PRODUCER_PORT
          value: "{{ rabbitmq_connection_port }}"
      k8s_deployment_additional_secret_variables:
        - name: DATA_UPDATER_PLANT_AMQP_CONSUMER_USERNAME
          secret_name: rabbitmq-user-credentials
          secret_key: admin-username
        - name: DATA_UPDATER_PLANT_AMQP_CONSUMER_PASSWORD
          secret_name: rabbitmq-user-credentials
          secret_key: admin-password
        - name: DATA_UPDATER_PLANT_AMQP_PRODUCER_USERNAME
          secret_name: rabbitmq-user-credentials
          secret_key: admin-username
        - name: DATA_UPDATER_PLANT_AMQP_PRODUCER_PASSWORD
          secret_name: rabbitmq-user-credentials
          secret_key: admin-password

    # Deploy AppEngine API
    - role: astarte-generic-api-service
      when: deploy_astarte_trigger_engine
      tags:
        - appengine
      astarte_app_name: appengine
      k8s_deployment_replicas: "{{ astarte_appengine_api_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_appengine_api_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_appengine_api_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_appengine_api_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_appengine_api_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: APPENGINE_API_ROOMS_AMQP_CLIENT_HOST
          value: "{{ astarte_appengine_api_rooms_amqp_client_host }}"
        - name: ASTARTE_CASSANDRA_NODES
          value: "{{ cassandra_nodesÂ }}"
      k8s_deployment_additional_secret_variables:
        - name: APPENGINE_API_ROOMS_AMQP_CLIENT_USERNAME
          secret_name: "{{ astarte_appengine_api_rooms_amqp_client_username_secret_name }}"
          secret_key: "{{ astarte_appengine_api_rooms_amqp_client_username_secret_key }}"
        - name: APPENGINE_API_ROOMS_AMQP_CLIENT_PASSWORD
          secret_name: "{{ astarte_appengine_api_rooms_amqp_client_password_secret_name }}"
          secret_key: "{{ astarte_appengine_api_rooms_amqp_client_password_secret_key }}"
      check_api_health: false

    # Deploy Trigger Engine
    - role: astarte-generic-backend-service
      when: deploy_astarte_trigger_engine
      tags:
        - trigger_engine
      astarte_app_name: trigger_engine
      k8s_deployment_replicas: "{{ astarte_trigger_engine_k8s_replicas }}"
      k8s_deployment_resources_requests_cpu: "{{ astarte_trigger_engine_k8s_resources_requests_cpu }}"
      k8s_deployment_resources_requests_memory: "{{ astarte_trigger_engine_k8s_resources_requests_memory }}"
      k8s_deployment_resources_limits_cpu: "{{ astarte_trigger_engine_k8s_resources_limits_cpu }}"
      k8s_deployment_resources_limits_memory: "{{ astarte_trigger_engine_k8s_resources_limits_memory }}"
      k8s_deployment_additional_variables:
        - name: TRIGGER_ENGINE_AMQP_CONSUMER_HOST
          value: "{{ rabbitmq_connection_host }}"
      k8s_deployment_additional_secret_variables:
        - name: TRIGGER_ENGINE_AMQP_CONSUMER_USERNAME
          secret_name: rabbitmq-user-credentials
          secret_key: admin-username
        - name: TRIGGER_ENGINE_AMQP_CONSUMER_PASSWORD
          secret_name: rabbitmq-user-credentials
          secret_key: admin-password

    # Deploy Dashboard
    - role: astarte-dashboard
      when: deploy_astarte_dashboard
      tags:
        - dashboard
