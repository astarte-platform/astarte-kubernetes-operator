---
astarte_k8s_namespace: "{{ lookup('vars', 'meta.namespace', default='astarte') }}"
astarte_distribution_channel: "{{ lookup('vars', 'distribution_channel', default='astarte') }}" # This defaults to the OSS public release on Docker Hub
astarte_tag: "{{ lookup('vars', 'version', default='0.10.0-beta.3') }}"
astarte_image_pull_policy: "{{ lookup('vars', 'image_pull_policy', default='IfNotPresent') }}"

# Reasonable defaults for standard K8S deployments
rabbitmq_connection_host: "rabbitmq.{{ astarte_k8s_namespace }}.svc.cluster.local"
rabbitmq_connection_port: "5672"
cassandra_nodes: "cassandra.{{ astarte_k8s_namespace }}.svc.cluster.local:9042"
cfssl_url: "http://cfssl.{{ astarte_k8s_namespace }}.svc.cluster.local"

# Reasonable K8S Deployment Policies
k8s_storage_class_name: "{{ lookup('vars', 'storage_class_name', default='') }}"
k8s_use_rbac: "{{ lookup('vars', 'rbac', default=true) }}"

### Ingress deployment control
astarte_api_use_ssl: "{{ lookup('vars', 'api.ssl', default=true) }}"
astarte_api_expose_housekeeping: true
astarte_api_enable_cors: false
astarte_api_host: "{{ lookup('vars', 'api.host', default='') }}"
astarte_dashboard_use_ssl: "{{ lookup('vars', 'components.dashboard.ssl', default=astarte_api_use_ssl) }}"
astarte_dashboard_use_dedicated_host: "{{ lookup('vars', 'components.dashboard.dedicated_host', default=deploy_astarte_dashboard) }}"
astarte_dashboard_host: "{{ lookup('vars', 'components.dashboard.host', default='') }}"
mqtt_broker_host: "{{ lookup('vars', 'vernemq.host', default='') }}"
mqtt_broker_port: "{{ lookup('vars', 'vernemq.port', default=8883) }}"
##### Voyager
deploy_voyager_broker_ingress: true
deploy_voyager_api_ingress: true
voyager_use_letsencrypt: true

### Control 3rd Party components deployment
deploy_vernemq_k8s: "{{ lookup('vars', 'vernemq.deploy', default=true) }}"
deploy_rabbitmq_k8s: "{{ lookup('vars', 'rabbitmq.deploy', default=true) }}"
deploy_cassandra_k8s: "{{ lookup('vars', 'cassandra.deploy', default=true) }}"
deploy_cfssl_k8s: "{{ lookup('vars', 'cfssl.deploy', default=true) }}"

### Control additional Astarte components deployment
deploy_astarte_trigger_engine: "{{ lookup('vars', 'components.trigger_engine.deploy', default=true) }}"
deploy_astarte_dashboard: "{{ lookup('vars', 'components.dashboard.deploy', default=true) }}"

### Data Updater Plant AMQP policies

### AppEngine API AMQP policies
astarte_appengine_api_rooms_amqp_client_host: "{{ rabbitmq_connection_host }}"
astarte_appengine_api_rooms_amqp_client_username_secret_name: rabbitmq-user-credentials
astarte_appengine_api_rooms_amqp_client_username_secret_key: admin-username
astarte_appengine_api_rooms_amqp_client_password_secret_name: rabbitmq-user-credentials
astarte_appengine_api_rooms_amqp_client_password_secret_key: admin-password

### Astarte Applications Resources and Replicas. You might want to override these.
## Global allocation. This is used to auto-weight resources.
astarte_k8s_resources_requests_cpu: "{{ lookup('vars', 'components.resources.requests.cpu', default='2000m') }}"
astarte_k8s_resources_requests_memory: "{{ lookup('vars', 'components.resources.requests.memory', default='4096M') }}"
astarte_k8s_resources_limits_cpu: "{{ lookup('vars', 'components.resources.limits.cpu', default='4000m') }}"
astarte_k8s_resources_limits_memory: "{{ lookup('vars', 'components.resources.limits.memory', default='8192M') }}"

## Derived variables. Don't touch!
astarte_k8s_resources_requests_cpu_millis: "{{ (astarte_k8s_resources_requests_cpu * 1000)|float if astarte_k8s_resources_requests_cpu is number else astarte_k8s_resources_requests_cpu|replace('m','')|float }}"
astarte_k8s_resources_requests_memory_megs: "{{ astarte_k8s_resources_requests_memory|replace('M','')|float if 'M' in astarte_k8s_resources_requests_memory else astarte_k8s_resources_requests_memory|replace('G','')|float * 1024.0 }}"
astarte_k8s_resources_limits_cpu_millis: "{{ (astarte_k8s_resources_limits_cpu * 1000)|float if astarte_k8s_resources_limits_cpu is number else astarte_k8s_resources_limits_cpu|replace('m','')|float }}"
astarte_k8s_resources_limits_memory_megs: "{{ astarte_k8s_resources_limits_memory|replace('M','')|float if 'M' in astarte_k8s_resources_limits_memory else astarte_k8s_resources_limits_memory|replace('G','')|float * 1024.0 }}"

## Housekeeping
astarte_housekeeping_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_housekeeping_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_housekeeping_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_housekeeping_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_housekeeping_k8s_replicas: 1
astarte_housekeeping_api_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_housekeeping_api_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_housekeeping_api_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_housekeeping_api_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_housekeeping_api_k8s_replicas: 1
## Realm Management
astarte_realm_management_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_realm_management_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_realm_management_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_realm_management_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_realm_management_k8s_replicas: 1
astarte_realm_management_api_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_realm_management_api_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_realm_management_api_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_realm_management_api_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_realm_management_api_k8s_replicas: 1
## Pairing
astarte_pairing_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_pairing_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_pairing_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_pairing_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_pairing_k8s_replicas: 1
astarte_pairing_api_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_pairing_api_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_pairing_api_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.07) | round(0, 'floor') | int | string + 'm' }}"
astarte_pairing_api_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.07) | round(0, 'floor') | int | string + 'M' }}"
astarte_pairing_api_k8s_replicas: 1
## Data Updater Plant
astarte_data_updater_plant_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.22) | round(0, 'floor') | int | string + 'm' }}"
astarte_data_updater_plant_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.22) | round(0, 'floor') | int | string + 'M' }}"
astarte_data_updater_plant_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.22) | round(0, 'floor') | int | string + 'm' }}"
astarte_data_updater_plant_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.22) | round(0, 'floor') | int | string + 'M' }}"
astarte_data_updater_plant_k8s_replicas: 1
## AppEngine API
astarte_appengine_api_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.22) | round(0, 'floor') | int | string + 'm' }}"
astarte_appengine_api_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.22) | round(0, 'floor') | int | string + 'M' }}"
astarte_appengine_api_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.22) | round(0, 'floor') | int | string + 'm' }}"
astarte_appengine_api_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.22) | round(0, 'floor') | int | string + 'M' }}"
astarte_appengine_api_k8s_replicas: 1
## Trigger Engine
astarte_trigger_engine_k8s_resources_requests_cpu: "{{ (astarte_k8s_resources_requests_cpu_millis|float * 0.14) | round(0, 'floor') | int | string + 'm' }}"
astarte_trigger_engine_k8s_resources_requests_memory: "{{ (astarte_k8s_resources_requests_memory_megs|float * 0.14) | round(0, 'floor') | int | string + 'M' }}"
astarte_trigger_engine_k8s_resources_limits_cpu: "{{ (astarte_k8s_resources_limits_cpu_millis|float * 0.14) | round(0, 'floor') | int | string + 'm' }}"
astarte_trigger_engine_k8s_resources_limits_memory: "{{ (astarte_k8s_resources_limits_memory_megs|float * 0.14) | round(0, 'floor') | int | string + 'M' }}"
astarte_trigger_engine_k8s_replicas: 1
