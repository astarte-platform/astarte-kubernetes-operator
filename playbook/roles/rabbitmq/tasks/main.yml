- name: Ensure Astarte namespace
  k8s:
    name: "{{Â astarte_k8s_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Retrieve RabbitMQ cookie secret
  k8s_facts:
    api_version: v1
    kind: Secret
    name: rabbitmq-cookie
    namespace: astarte
  register: rabbitmq_cookie

- name: Create RabbitMQ cookie secret
  k8s:
    state: present
    definition: "{{ lookup('template', 'rabbitmq-cookie.yml') }}"
  when: not rabbitmq_cookie.resources

- name: Retrieve RabbitMQ user credentials
  k8s_facts:
    api_version: v1
    kind: Secret
    name: rabbitmq-user-credentials
    namespace: astarte
  register: rabbitmq_user_credentials

- name: Create RabbitMQ user credentials
  k8s:
    state: present
    definition: "{{ lookup('template', 'rabbitmq-user-credentials.yml') }}"
  when: not rabbitmq_user_credentials.resources

- name: Create RabbitMQ Service Account
  k8s:
    state: present
    definition: "{{ lookup('file', 'rabbitmq-rbac.yml') }}"
  when: k8s_use_rbac

- name: Ensure RabbitMQ StatefulSet
  k8s:
    state: present
    definition: "{{ lookup('template', 'rabbitmq-statefulset.yml') }}"

- name: Ensure RabbitMQ Service
  k8s:
    state: present
    definition: "{{ lookup('template', 'rabbitmq-service.yml') }}"
